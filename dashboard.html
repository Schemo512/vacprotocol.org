<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VAC Dashboard</title>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<style>
:root { --bg: #0D1117; --surface: #161B22; --surface-raised: #1C2128; --border: #30363D; --border-light: #484F58; --text-primary: #F0F6FC; --text-secondary: #C9D1D9; --text-tertiary: #8B949E; --text-quaternary: #6E7681; --purple: #6C5CE7; --purple-bg: rgba(108,92,231,0.08); --purple-border: rgba(108,92,231,0.25); --teal: #00CEC9; --success: #3FB950; --success-bg: rgba(63,185,80,0.08); --success-border: rgba(63,185,80,0.2); --warning: #D29922; --warning-bg: rgba(210,153,34,0.08); --error: #F85149; --error-bg: rgba(248,81,73,0.08); --radius: 10px; --mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace; --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font); background: var(--bg); color: var(--text-secondary); line-height: 1.6; }
.nav { border-bottom: 1px solid var(--border); padding: 12px 20px; background: var(--bg); position: sticky; top: 0; z-index: 50; }
.nav-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
.nav-brand { font-family: var(--mono); font-weight: 700; font-size: 13px; color: var(--text-primary); letter-spacing: 2px; display: flex; align-items: center; gap: 8px; }
.nav-brand span { font-weight: 400; color: var(--text-tertiary); }
.nav-mode { font-family: var(--mono); font-size: 10px; color: var(--purple); background: var(--purple-bg); border: 1px solid var(--purple-border); padding: 3px 8px; border-radius: 4px; letter-spacing: 1px; }
.page { max-width: 900px; margin: 0 auto; padding: 24px 20px 80px; }

/* Profile header */
.profile-header { display: flex; align-items: center; gap: 16px; padding: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 20px; }
.profile-avatar { width: 56px; height: 56px; border-radius: 50%; background: var(--purple-bg); border: 2px solid var(--purple); display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 700; color: var(--purple); flex-shrink: 0; }
.profile-info { flex: 1; }
.profile-name { font-size: 18px; font-weight: 700; color: var(--text-primary); }
.profile-meta { font-family: var(--mono); font-size: 12px; color: var(--text-tertiary); }
.profile-score { font-family: var(--mono); font-size: 24px; font-weight: 700; color: var(--teal); text-align: right; }
.profile-score-label { font-size: 10px; color: var(--text-quaternary); letter-spacing: 1px; text-transform: uppercase; }

/* Stat cards */
.stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; }
.stat-value { font-family: var(--mono); font-size: 22px; font-weight: 700; color: var(--text-primary); }
.stat-label { font-family: var(--mono); font-size: 10px; color: var(--text-quaternary); letter-spacing: 1px; text-transform: uppercase; }

/* Section headers */
.section-header { display: flex; align-items: center; justify-content: space-between; margin: 24px 0 12px; }
.section-title { font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--text-tertiary); letter-spacing: 1.5px; text-transform: uppercase; }
.section-action { font-family: var(--mono); font-size: 11px; color: var(--purple); cursor: pointer; text-decoration: none; }

/* Cards */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 10px; }
.card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
.card-meta { font-family: var(--mono); font-size: 11px; color: var(--text-quaternary); }

/* Agent cards */
.agent-card { display: flex; align-items: center; gap: 12px; }
.agent-icon { width: 36px; height: 36px; border-radius: 8px; background: var(--purple-bg); border: 1px solid var(--purple-border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.agent-info { flex: 1; }
.agent-actions { display: flex; gap: 6px; }
.agent-actions button { font-family: var(--mono); font-size: 10px; padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--surface-raised); color: var(--text-tertiary); cursor: pointer; }
.agent-actions button:hover { border-color: var(--purple-border); color: var(--purple); }
.agent-actions button.danger { border-color: var(--error-bg); color: var(--error); }
.agent-actions button.danger:hover { background: var(--error-bg); }

/* Contact cards */
.contact-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.contact-row:last-child { border-bottom: none; }
.contact-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--surface-raised); display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--text-tertiary); flex-shrink: 0; }
.contact-info { flex: 1; }
.contact-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.contact-email { font-family: var(--mono); font-size: 11px; color: var(--text-quaternary); }
.badge { font-family: var(--mono); font-size: 10px; padding: 2px 8px; border-radius: 4px; letter-spacing: 0.5px; }
.badge.mutual { background: var(--success-bg); color: var(--success); border: 1px solid var(--success-border); }
.badge.one-way { background: var(--purple-bg); color: var(--purple); border: 1px solid var(--purple-border); }
.badge.invited { background: var(--warning-bg); color: var(--warning); border: 1px solid rgba(210,153,34,0.2); }

/* Settings */
.setting-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
.setting-row:last-child { border-bottom: none; }
.setting-label { font-size: 13px; color: var(--text-secondary); }
.setting-value { font-family: var(--mono); font-size: 12px; color: var(--teal); }
.setting-input { font-family: var(--mono); font-size: 12px; background: var(--surface-raised); border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; color: var(--text-primary); width: 100px; text-align: right; }

/* Budget bar */
.budget-row { margin-bottom: 10px; }
.budget-header { display: flex; justify-content: space-between; margin-bottom: 3px; }
.budget-label { font-size: 12px; color: var(--text-secondary); }
.budget-value { font-family: var(--mono); font-size: 11px; color: var(--text-tertiary); }
.budget-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.budget-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }

/* Loading */
.loading { text-align: center; padding: 40px; font-family: var(--mono); font-size: 12px; color: var(--text-quaternary); }

/* Empty state */
.empty { text-align: center; padding: 24px; font-size: 13px; color: var(--text-quaternary); }
.empty a { color: var(--purple); text-decoration: none; }

/* Responsive */
@media (max-width: 600px) { .stat-row { grid-template-columns: repeat(2, 1fr); } }
</style>
</head>
<body>
<div class="nav"><div class="nav-inner">
    <div class="nav-brand">
        <svg width="20" height="20" viewBox="0 0 100 100"><polygon points="50,8 92,30 92,70 50,92 8,70 8,30" fill="none" stroke="#6C5CE7" stroke-width="5"/><polygon points="50,24 76,38 76,62 50,76 24,62 24,38" fill="#6C5CE7" fill-opacity="0.1" stroke="#6C5CE7" stroke-width="2.5"/></svg>
        VAC <span>DASHBOARD</span>
    </div>
    <div class="nav-mode">CONTROL PLANE</div>
</div></div>

<div class="page" id="content">
    <div class="loading" id="loadingState">Loading dashboard…</div>
</div>

<script>
const API = 'https://vac-system-production.up.railway.app';
const params = new URLSearchParams(window.location.search);
const email = params.get('email') || '';

async function init() {
    if (!email) {
        document.getElementById('content').innerHTML = `
            <div class="empty" style="margin-top:80px;">
                <svg width="48" height="48" viewBox="0 0 100 100" style="margin-bottom:16px;"><polygon points="50,8 92,30 92,70 50,92 8,70 8,30" fill="none" stroke="var(--border-light)" stroke-width="4"/></svg>
                <div style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">No user specified</div>
                <div>Complete verification first: <a href="/auth">vacprotocol.org/auth</a></div>
            </div>`;
        return;
    }

    try {
        const r = await fetch(`${API}/v1/user/${encodeURIComponent(email)}`);
        if (!r.ok) throw new Error('User not found');
        const data = await r.json();
        render(data);
    } catch (e) {
        document.getElementById('content').innerHTML = `
            <div class="empty" style="margin-top:80px;">
                <div style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">User not found</div>
                <div>Verify your identity first: <a href="/auth">vacprotocol.org/auth</a></div>
                <div style="font-family:var(--mono);font-size:11px;color:var(--text-quaternary);margin-top:8px;">${email}</div>
            </div>`;
    }
}

function render(data) {
    const u = data.user;
    const initials = u.name.split(' ').map(n => n[0]).join('').toUpperCase();
    const scorePct = (u.trust_score * 100).toFixed(0);
    const pd = data.protection_defaults;
    const ab = data.agent_budget_defaults;

    let h = '';

    // Profile header
    h += `<div class="profile-header">
        <div class="profile-avatar">${initials}</div>
        <div class="profile-info">
            <div class="profile-name">${u.name}</div>
            <div class="profile-meta">${u.org ? u.org + ' · ' : ''}${u.email}</div>
            <div class="profile-meta">${u.total_verifications} verification${u.total_verifications !== 1 ? 's' : ''} · Last: ${u.last_verified_at ? timeAgo(u.last_verified_at) : 'never'}</div>
        </div>
        <div style="text-align:right;">
            <div class="profile-score">${scorePct}%</div>
            <div class="profile-score-label">Trust Score</div>
        </div>
    </div>`;

    // Stats
    h += `<div class="stat-row">
        <div class="stat-card"><div class="stat-value">${data.contacts_count}</div><div class="stat-label">Contacts</div></div>
        <div class="stat-card"><div class="stat-value">${data.agents_count}</div><div class="stat-label">Active Agents</div></div>
        <div class="stat-card"><div class="stat-value">${data.messages.sent}</div><div class="stat-label">Sent</div></div>
        <div class="stat-card"><div class="stat-value">${data.messages.received}</div><div class="stat-label">Received</div></div>
    </div>`;

    // Active agents
    h += `<div class="section-header"><div class="section-title">Active Agents</div><a href="/auth" class="section-action">+ New Agent</a></div>`;
    if (data.agents.length === 0) {
        h += '<div class="card"><div class="empty">No active agents. <a href="/auth">Verify to create your first chain.</a></div></div>';
    } else {
        data.agents.forEach(a => {
            const constraints = a.constraints || {};
            const budgetItems = [];
            if (constraints.max_spend_usd) budgetItems.push({ label: 'USD', max: constraints.max_spend_usd, unit: '$' });
            if (constraints.token_budget) budgetItems.push({ label: 'Tokens', max: constraints.token_budget, unit: '' });
            if (constraints.max_api_calls) budgetItems.push({ label: 'API Calls', max: constraints.max_api_calls, unit: '' });

            h += `<div class="card"><div class="agent-card">
                <div class="agent-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><circle cx="12" cy="5" r="4"/></svg></div>
                <div class="agent-info">
                    <div class="card-title">${a.agent_id}</div>
                    <div class="card-meta">Depth ${a.depth} · Trust ${(a.trust_score * 100).toFixed(0)}%</div>
                </div>
                <div class="agent-actions">
                    <button onclick="window.open('${a.verify_url}')">View</button>
                    <button class="danger" onclick="revokeAgent('${a.jti}')">Revoke</button>
                </div>
            </div>`;
            // Budget bars
            if (budgetItems.length > 0) {
                h += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);">';
                budgetItems.forEach(b => {
                    // We don't have spend totals here, show max budget
                    h += `<div class="budget-row">
                        <div class="budget-header"><span class="budget-label">${b.label}</span><span class="budget-value">${b.unit}${b.max.toLocaleString()} max</span></div>
                        <div class="budget-bar"><div class="budget-fill" style="width:0%;background:var(--success);"></div></div>
                    </div>`;
                });
                h += '</div>';
            }
            h += '</div>';
        });
    }

    // Contacts / Authenticated Parties
    h += `<div class="section-header"><div class="section-title">Authenticated Contacts</div><a href="/msg?from=${encodeURIComponent(email)}&name=${encodeURIComponent(u.name)}" class="section-action">+ Send Message</a></div>`;
    if (data.contacts.length === 0) {
        h += '<div class="card"><div class="empty">No contacts yet. Share your verification link to build your trust network.</div></div>';
    } else {
        h += '<div class="card">';
        data.contacts.forEach(c => {
            const badgeClass = c.state === 'mutual' ? 'mutual' : (c.state === 'vouched' || c.state === 'invited_back') ? 'one-way' : 'invited';
            const badgeText = c.state === 'mutual' ? 'Mutual' : c.state === 'invited' ? 'Invited' : 'Vouched';
            const ci = (c.name || c.email.split('@')[0]).substring(0, 2).toUpperCase();
            h += `<div class="contact-row">
                <div class="contact-avatar">${ci}</div>
                <div class="contact-info">
                    <div class="contact-name">${c.name || c.email}</div>
                    <div class="contact-email">${c.email}</div>
                </div>
                <span class="badge ${badgeClass}">${badgeText}</span>
                <a href="/msg?from=${encodeURIComponent(email)}&name=${encodeURIComponent(u.name)}&to=${encodeURIComponent(c.email)}" style="font-family:var(--mono);font-size:10px;color:var(--teal);text-decoration:none;">MSG</a>
            </div>`;
        });
        h += '</div>';
    }

    // Default settings
    h += `<div class="section-header"><div class="section-title">Default Settings</div></div>`;
    h += '<div class="card">';
    h += '<div style="font-family:var(--mono);font-size:10px;color:var(--text-quaternary);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">Message Protection Defaults</div>';
    h += `<div class="setting-row"><span class="setting-label">Ephemeral (no device storage)</span><span class="setting-value">${pd.ephemeral ? 'On' : 'Off'}</span></div>`;
    h += `<div class="setting-row"><span class="setting-label">Attention-gated (blur when not looking)</span><span class="setting-value">${pd.attention_gated ? 'On' : 'Off'}</span></div>`;
    h += `<div class="setting-row"><span class="setting-label">Geo-fenced (location restricted)</span><span class="setting-value">${pd.geo_fenced ? 'On' : 'Off'}</span></div>`;
    h += '<div style="font-family:var(--mono);font-size:10px;color:var(--text-quaternary);letter-spacing:1px;text-transform:uppercase;margin:16px 0 8px;border-top:1px solid var(--border);padding-top:12px;">Agent Budget Defaults</div>';
    h += `<div class="setting-row"><span class="setting-label">Max spend per agent (USD)</span><input class="setting-input" type="number" value="${ab.max_spend_usd || 50}" id="setSpend"></div>`;
    h += `<div class="setting-row"><span class="setting-label">Token budget per agent</span><input class="setting-input" type="number" value="${ab.token_budget || 500000}" id="setTokens"></div>`;
    h += `<div class="setting-row"><span class="setting-label">Max API calls per agent</span><input class="setting-input" type="number" value="${ab.max_api_calls || 1000}" id="setCalls"></div>`;
    h += '<div style="margin-top:12px;text-align:right;"><button onclick="saveDefaults()" style="font-family:var(--mono);font-size:11px;padding:6px 16px;border-radius:4px;border:1px solid var(--purple-border);background:var(--purple-bg);color:var(--purple);cursor:pointer;">Save Defaults</button></div>';
    h += '</div>';

    // Quick links
    h += `<div style="display:flex;gap:8px;margin-top:20px;">
        <a href="/auth" style="flex:1;text-align:center;font-family:var(--mono);font-size:11px;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text-tertiary);text-decoration:none;">Re-verify</a>
        <a href="/msg?from=${encodeURIComponent(email)}&name=${encodeURIComponent(u.name)}" style="flex:1;text-align:center;font-family:var(--mono);font-size:11px;padding:10px;border-radius:6px;border:1px solid var(--purple-border);background:var(--purple-bg);color:var(--purple);text-decoration:none;">New Message</a>
    </div>`;

    document.getElementById('content').innerHTML = h;
}

function timeAgo(iso) {
    const ms = Date.now() - new Date(iso).getTime();
    const mins = Math.floor(ms / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    return Math.floor(hrs / 24) + 'd ago';
}

async function revokeAgent(jti) {
    if (!confirm('Revoke this agent and all downstream chains? This cannot be undone.')) return;
    try {
        await fetch(`${API}/v1/vat/revoke/${jti}?cascade=true`, { method: 'POST' });
        alert('Agent revoked.');
        location.reload();
    } catch (e) { alert('Revocation failed: ' + e.message); }
}

async function saveDefaults() {
    const spend = parseFloat(document.getElementById('setSpend').value) || 50;
    const tokens = parseInt(document.getElementById('setTokens').value) || 500000;
    const calls = parseInt(document.getElementById('setCalls').value) || 1000;
    try {
        await fetch(`${API}/v1/user/${encodeURIComponent(email)}/defaults`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agent_budget_defaults: { max_spend_usd: spend, token_budget: tokens, max_api_calls: calls } }),
        });
        alert('Defaults saved.');
    } catch (e) { alert('Save failed: ' + e.message); }
}

init();
</script>
</body>
</html>
