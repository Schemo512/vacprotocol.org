<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VAC Protocol — Authenticate</title>
<meta name="description" content="Verify your identity and mint a cryptographic authority chain with VAC Protocol.">
<meta property="og:title" content="VAC Protocol — Authenticate">
<meta property="og:description" content="Biometric verification → cryptographic authority chain. 285 patent claims. Math so neither party has to rely on trust alone.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://vacprotocol.org/auth">
<meta property="og:image" content="https://vacprotocol.org/og-image.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@vacprotocol">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<style>
/* ─── Theme defaults (overridden by vac-themes.js at runtime) ─── */
:root {
    --bg: #0D1117;
    --surface: #161B22;
    --surface-raised: #1C2128;
    --border: #30363D;
    --border-light: #3D444D;
    --text-primary: #F0F6FC;
    --text-secondary: #C9D1D9;
    --text-tertiary: #8B949E;
    --text-quaternary: #6E7681;
    --purple: #6C5CE7;
    --purple-dim: #5A4BD1;
    --purple-bg: rgba(108,92,231,0.08);
    --purple-border: rgba(108,92,231,0.25);
    --teal: #00CEC9;
    --teal-bg: rgba(0,206,201,0.08);
    --teal-border: rgba(0,206,201,0.2);
    --success: #3FB950;
    --success-bg: rgba(63,185,80,0.08);
    --success-border: rgba(63,185,80,0.2);
    --error: #F85149;
    --error-bg: rgba(248,81,73,0.08);
    --error-border: rgba(248,81,73,0.2);
    --warning: #D29922;
    --radius: 8px;
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    --mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font); color: var(--text-secondary); background: var(--bg); font-size: 15px; line-height: 1.6; -webkit-font-smoothing: antialiased; min-height: 100dvh; }

.page { max-width: 560px; margin: 0 auto; padding: 0 20px 60px; }

/* Nav */
.nav { border-bottom: 1px solid var(--border); padding: 0 20px; background: rgba(13,17,23,0.95); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 100; }
.nav-inner { max-width: 560px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 52px; }
.nav-left { display: flex; align-items: center; gap: 10px; text-decoration: none; }
.nav-icon { width: 22px; height: 22px; }
.nav-wordmark { font-weight: 700; font-size: 13px; color: var(--text-primary); letter-spacing: 1.5px; }
.nav-wordmark span { font-weight: 400; color: var(--text-tertiary); letter-spacing: 1px; }
.nav-mode { font-family: var(--mono); font-size: 10px; padding: 3px 8px; border-radius: 4px; letter-spacing: 0.5px; font-weight: 600; color: var(--purple); background: var(--purple-bg); border: 1px solid var(--purple-border); }

/* Step indicators */
.steps-bar { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 20px 0 8px; }
.step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); transition: all 0.3s; }
.step-dot.active { background: var(--purple); box-shadow: 0 0 8px rgba(108,92,231,0.4); }
.step-dot.done { background: var(--success); }
.step-line { width: 24px; height: 1.5px; background: var(--border); transition: background 0.3s; }
.step-line.done { background: var(--success); }

/* Sections */
.step-section { display: none; animation: fadeIn 0.35s ease-out; }
.step-section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.header { text-align: center; padding: 32px 0 24px; }
.header-eyebrow { font-family: var(--mono); font-size: 11px; color: var(--teal); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
.header-title { font-size: 24px; font-weight: 700; color: var(--text-primary); line-height: 1.3; }
.header-sub { font-size: 14px; color: var(--text-tertiary); margin-top: 8px; max-width: 400px; margin-left: auto; margin-right: auto; }

/* Forms */
.form-group { margin-bottom: 16px; }
.form-label { font-family: var(--mono); font-size: 11px; color: var(--text-tertiary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; display: block; }
.form-input { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px 14px; font-family: var(--font); font-size: 15px; color: var(--text-primary); outline: none; transition: border-color 0.15s; }
.form-input:focus { border-color: var(--purple); }
.form-input::placeholder { color: var(--text-quaternary); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* Buttons */
.btn-primary { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: var(--purple); color: #fff; font-family: var(--font); font-weight: 600; font-size: 15px; padding: 14px 32px; border-radius: var(--radius); border: none; cursor: pointer; transition: all 0.15s; letter-spacing: 0.3px; width: 100%; min-height: 48px; }
.btn-primary:hover { background: var(--purple-dim); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(108,92,231,0.25); }
.btn-primary:disabled { opacity: 0.5; cursor: default; transform: none; box-shadow: none; }
.btn-secondary { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: var(--surface); color: var(--text-primary); font-family: var(--font); font-weight: 600; font-size: 14px; padding: 12px 24px; border-radius: var(--radius); border: 1px solid var(--border); cursor: pointer; transition: all 0.15s; min-height: 44px; }
.btn-secondary:hover { border-color: var(--purple); background: var(--purple-bg); }

/* Camera */
.camera-container { position: relative; width: 100%; aspect-ratio: 4/3; min-height: 240px; background: #000; border-radius: 12px; overflow: hidden; border: 2px solid var(--border); margin-bottom: 20px; }
.camera-container.recording { border-color: var(--error); box-shadow: 0 0 20px rgba(248,81,73,0.15); }
.camera-container.verified { border-color: var(--success); box-shadow: 0 0 20px rgba(63,185,80,0.15); }
#videoPreview, #videoPreviewRec { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); display: block; background: #000; }

/* Face oval guide */
.face-oval { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 240px; pointer-events: none; }
.face-oval-ring { fill: none; stroke: var(--purple); stroke-width: 2; stroke-dasharray: 8 4; opacity: 0.6; transition: all 0.3s; }
.camera-container.face-detected .face-oval-ring { stroke: var(--success); stroke-dasharray: none; opacity: 0.8; }
.face-oval-label { position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); font-family: var(--mono); font-size: 10px; color: var(--text-tertiary); letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 3px; }

/* Countdown ring */
.countdown-ring-wrap { width: 100px; height: 100px; margin: 8px auto; position: relative; }
.countdown-ring-wrap svg { transform: rotate(-90deg); width: 100%; height: 100%; }
.countdown-ring-wrap .ring-bg { fill: none; stroke: var(--border); stroke-width: 3; }
.countdown-ring-wrap .ring-fill { fill: none; stroke: var(--purple); stroke-width: 3; stroke-linecap: round; stroke-dasharray: 245; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
.countdown-ring-wrap .ring-fill.recording { stroke: var(--error); }
.countdown-number { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: var(--mono); font-size: 32px; font-weight: 700; color: var(--text-primary); }

/* Privacy statement */
.privacy-statement { display: flex; align-items: flex-start; gap: 10px; padding: 12px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px; font-size: 12px; color: var(--text-tertiary); line-height: 1.5; }
.privacy-statement svg { flex-shrink: 0; margin-top: 1px; }

/* Scroll indicator */
.scroll-hint { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); z-index: 90; opacity: 0.7; transition: opacity 0.3s; pointer-events: none; }
.scroll-hint.hidden { opacity: 0; }
.scroll-hint svg { animation: bounce-down 1.5s ease-in-out infinite; }
@keyframes bounce-down { 0%,100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

/* Audio level indicator */
.audio-level { position: absolute; bottom: 24px; right: 24px; display: flex; align-items: flex-end; gap: 2px; height: 24px; background: rgba(0,0,0,0.6); padding: 4px 6px; border-radius: 4px; }
.audio-bar { width: 3px; background: var(--success); border-radius: 1px; transition: height 0.08s ease-out; min-height: 2px; }
.camera-overlay { position: absolute; inset: 0; pointer-events: none; }
.camera-corners { position: absolute; inset: 16px; }
.camera-corners::before, .camera-corners::after { content: ''; position: absolute; width: 24px; height: 24px; border-color: var(--purple); border-style: solid; }
.camera-corners::before { top: 0; left: 0; border-width: 2px 0 0 2px; border-radius: 4px 0 0 0; }
.camera-corners::after { top: 0; right: 0; border-width: 2px 2px 0 0; border-radius: 0 4px 0 0; }
.camera-corners-bottom { position: absolute; inset: 16px; }
.camera-corners-bottom::before, .camera-corners-bottom::after { content: ''; position: absolute; width: 24px; height: 24px; border-color: var(--purple); border-style: solid; }
.camera-corners-bottom::before { bottom: 0; left: 0; border-width: 0 0 2px 2px; border-radius: 0 0 0 4px; }
.camera-corners-bottom::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; border-radius: 0 0 4px 0; }
.camera-label { position: absolute; top: 24px; left: 50%; transform: translateX(-50%); font-family: var(--mono); font-size: 11px; color: var(--teal); letter-spacing: 1.5px; text-transform: uppercase; background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 4px; }
.rec-indicator { position: absolute; top: 24px; right: 24px; display: flex; align-items: center; gap: 6px; font-family: var(--mono); font-size: 11px; color: var(--error); letter-spacing: 1px; background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 4px; }
.rec-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--error); animation: pulse-rec 1s ease-in-out infinite; }
@keyframes pulse-rec { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
.camera-challenge { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); max-width: 80%; text-align: center; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); padding: 10px 20px; border-radius: 8px; border: 1px solid rgba(108,92,231,0.3); }
.camera-challenge-text { font-size: 16px; font-weight: 600; color: var(--text-primary); }
.camera-challenge-sub { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }

/* Progress */
.progress-container { text-align: center; padding: 40px 0; }
.progress-ring { width: 80px; height: 80px; margin: 0 auto 20px; position: relative; }
.progress-ring svg { transform: rotate(-90deg); }
.progress-ring circle { fill: none; stroke-width: 3; }
.progress-ring .ring-bg { stroke: var(--border); }
.progress-ring .ring-fill { stroke: var(--purple); stroke-dasharray: 226; stroke-dashoffset: 226; transition: stroke-dashoffset 0.3s; stroke-linecap: round; }
.progress-step { font-family: var(--mono); font-size: 12px; color: var(--text-tertiary); margin-bottom: 8px; }
.progress-detail { font-size: 14px; color: var(--text-secondary); }

/* Modality results in processing */
.modality-results { max-width: 360px; margin: 20px auto 0; }
.mod-result { display: flex; align-items: center; gap: 10px; padding: 8px 0; font-size: 13px; }
.mod-result + .mod-result { border-top: 1px solid var(--border); }
.mod-status { width: 20px; text-align: center; font-size: 14px; }
.mod-name { flex: 1; color: var(--text-secondary); }
.mod-score { font-family: var(--mono); font-size: 12px; font-weight: 600; }
.mod-score.pass { color: var(--success); }
.mod-score.fail { color: var(--error); }
.mod-score.pending { color: var(--text-quaternary); }

/* Success chain display */
.chain-result { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px; }
.chain-node-result { display: flex; align-items: center; gap: 12px; padding: 10px 0; }
.chain-node-result + .chain-node-result { border-top: 1px solid var(--border); }
.chain-depth { font-family: var(--mono); font-size: 10px; color: var(--text-quaternary); width: 16px; text-align: center; }
.chain-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.chain-icon.human { background: var(--teal-bg); border: 1px solid var(--teal-border); }
.chain-icon.agent { background: var(--purple-bg); border: 1px solid var(--purple-border); }
.chain-info { flex: 1; min-width: 0; }
.chain-agent-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.chain-scope { font-family: var(--mono); font-size: 11px; color: var(--text-tertiary); }
.chain-trust { font-family: var(--mono); font-size: 12px; font-weight: 600; }
.chain-trust.high { color: var(--success); }
.chain-trust.mid { color: var(--warning); }
.chain-arrow { text-align: center; color: var(--text-quaternary); font-size: 11px; padding: 2px 0; }

/* Share section */
.share-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px; }
.share-url { font-family: var(--mono); font-size: 12px; color: var(--teal); background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; word-break: break-all; margin: 12px 0; cursor: pointer; transition: border-color 0.15s; }
.share-url:hover { border-color: var(--teal-border); }

/* Patent badge */
.patent-badge { display: inline-flex; align-items: center; gap: 6px; font-family: var(--mono); font-size: 11px; color: var(--text-tertiary); background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 6px 14px; margin-top: 16px; }
.patent-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--purple); }

/* Modality list */
.modalities-mini { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
.mod-chip { display: inline-flex; align-items: center; gap: 5px; font-family: var(--mono); font-size: 11px; color: var(--success); background: var(--success-bg); border: 1px solid var(--success-border); border-radius: 4px; padding: 3px 8px; }
.mod-chip .dot { width: 5px; height: 5px; border-radius: 50%; background: var(--success); }
.mod-chip.failed { color: var(--error); background: var(--error-bg); border-color: var(--error-border); }
.mod-chip.failed .dot { background: var(--error); }
.mod-chip.optional { opacity: 0.45; }
.mod-chip.optional .dot { background: var(--text-quaternary); }
.mod-chip.recommended { opacity: 0.7; border-style: dashed; }
.adaptive-auth-bar { text-align: center; margin-bottom: 8px; font-family: var(--mono); font-size: 11px; letter-spacing: 0.5px; padding: 6px 12px; border-radius: 6px; }
.adaptive-auth-bar.streamlined { color: var(--success); background: var(--success-bg); border: 1px solid var(--success-border); }
.adaptive-auth-bar.standard { color: var(--purple); background: var(--purple-bg); border: 1px solid var(--purple-border); }

/* Timer */
.timer-display { font-family: var(--mono); font-size: 36px; font-weight: 700; color: var(--text-primary); text-align: center; margin: 8px 0; }
.timer-label { font-family: var(--mono); font-size: 11px; color: var(--text-tertiary); text-align: center; letter-spacing: 1px; text-transform: uppercase; margin-top: 12px; margin-bottom: 8px; }

/* Footer tagline */
.footer-tagline { text-align: center; padding: 24px 0; font-size: 13px; font-style: italic; color: var(--text-quaternary); border-top: 1px solid var(--border); margin-top: 24px; }

/* Error */
.error-msg { font-size: 13px; color: var(--error); text-align: center; margin-top: 12px; font-family: var(--mono); }

/* Claim mapping pills */
.claim-pills { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 10px; }
.claim-pill { font-family: var(--mono); font-size: 10px; color: var(--text-quaternary); background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 2px 6px; }
.claim-pill.active { color: var(--purple); border-color: var(--purple-border); background: var(--purple-bg); }

/* Transcript display */
.transcript-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-top: 12px; }
.transcript-label { font-family: var(--mono); font-size: 10px; color: var(--text-quaternary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
.transcript-text { font-size: 14px; color: var(--text-primary); font-style: italic; }
.transcript-match { font-family: var(--mono); font-size: 11px; margin-top: 6px; }
</style>
</head>
<body>

<!-- NAV -->
<div class="nav">
<div class="nav-inner">
    <a href="/" class="nav-left">
        <svg class="nav-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <polygon points="50,8 92,30 92,70 50,92 8,70 8,30" fill="none" stroke="#6C5CE7" stroke-width="4"/>
            <polygon points="50,24 76,38 76,62 50,76 24,62 24,38" fill="#6C5CE7" fill-opacity="0.15" stroke="#6C5CE7" stroke-width="2"/>
            <circle cx="50" cy="44" r="10" fill="none" stroke="#00CEC9" stroke-width="2.5"/>
            <path d="M35 68 Q50 56 65 68" fill="none" stroke="#00CEC9" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
        <div class="nav-wordmark">VAC <span>PROTOCOL</span></div>
    </a>
    <div class="nav-mode">AUTHENTICATE</div>
</div>
</div>

<div class="page">

<!-- STEP INDICATORS -->
<div class="steps-bar">
    <div class="step-dot active" id="dot0"></div>
    <div class="step-line" id="line0"></div>
    <div class="step-dot" id="dot1"></div>
    <div class="step-line" id="line1"></div>
    <div class="step-dot" id="dot2"></div>
    <div class="step-line" id="line2"></div>
    <div class="step-dot" id="dot3"></div>
</div>

<!-- STEP 0: Identity -->
<div class="step-section active" id="step0">
    <div class="header">
        <div class="header-eyebrow">Step 1 of 4</div>
        <div class="header-title">Verify Your Identity</div>
        <div class="header-sub">Prove you're a real human. Your verified identity becomes a cryptographic credential that agents, services, and people can trust.</div>
    </div>
    <div class="form-group">
        <label class="form-label">Full Name</label>
        <input class="form-input" id="inputName" type="text" placeholder="Rob Zagarella" autocomplete="name">
    </div>
    <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="inputEmail" type="email" placeholder="rob@violetshores.com" autocomplete="email">
    </div>
    <div id="optionalFields" style="display:none;">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Organisation <span style="font-weight:400;color:var(--text-quaternary);">(optional)</span></label>
                <input class="form-input" id="inputOrg" type="text" placeholder="Violet Shores">
            </div>
            <div class="form-group">
                <label class="form-label">Role <span style="font-weight:400;color:var(--text-quaternary);">(optional)</span></label>
                <input class="form-input" id="inputRole" type="text" placeholder="Founder">
            </div>
        </div>
    </div>
    <div style="text-align:center;margin-bottom:16px;">
        <button id="toggleOrgBtn" onclick="toggleOrgFields()" style="background:none;border:none;font-family:var(--mono);font-size:11px;color:var(--text-tertiary);cursor:pointer;padding:4px 8px;">+ Add organisation details</button>
    </div>
    <button class="btn-primary" id="btnIdentity" onclick="goToCamera()">
        Continue
    </button>
    <div id="identityError" class="error-msg" style="display:none;"></div>
</div>

<!-- STEP 1: Camera Access -->
<div class="step-section" id="step1">
    <div class="header">
        <div class="header-eyebrow">Step 2 of 4</div>
        <div class="header-title">Camera & Microphone</div>
        <div class="header-sub">We'll record a short video of you speaking a challenge phrase. This takes about 10 seconds.</div>
    </div>
    <div class="camera-container" id="cameraBox">
        <video id="videoPreview" autoplay playsinline muted></video>
        <div class="camera-overlay">
            <div class="camera-corners"></div>
            <div class="camera-corners-bottom"></div>
            <div class="face-oval" id="faceOval">
                <svg viewBox="0 0 180 240" width="180" height="240">
                    <ellipse class="face-oval-ring" cx="90" cy="120" rx="75" ry="105"/>
                </svg>
                <div class="face-oval-label" id="faceOvalLabel">Position face in oval</div>
            </div>
            <div class="camera-label" id="cameraLabel">AWAITING CAMERA</div>
        </div>
    </div>
    <div class="privacy-statement">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L2 4v4c0 3.5 2.6 6.8 6 7.5 3.4-.7 6-4 6-7.5V4L8 1z" stroke="currentColor" stroke-width="1.5" fill="none"/><path d="M6 8l1.5 1.5L10 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Your biometric data is processed in real-time for verification only. Video is not stored after analysis. VAC Protocol does not retain facial images or voice recordings.</span>
    </div>
    <button class="btn-primary" id="btnCamera" onclick="requestCamera()">
        Enable Camera & Microphone
    </button>
    <div id="cameraError" class="error-msg" style="display:none;"></div>
    <div id="preRecordChecklist" style="display:none; margin-top: 16px; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px;">
        <div style="font-family: var(--mono); font-size: 11px; font-weight: 600; color: var(--teal); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px;">Pre-Recording Check</div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-secondary); cursor: pointer;">
                <input type="checkbox" class="pre-check" style="width: 18px; height: 18px; accent-color: var(--purple);" onchange="checkReady()">
                <span>I can see my face clearly in the preview</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-secondary); cursor: pointer;">
                <input type="checkbox" class="pre-check" style="width: 18px; height: 18px; accent-color: var(--purple);" onchange="checkReady()">
                <span>Good lighting on my face (no backlight)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-secondary); cursor: pointer;">
                <input type="checkbox" class="pre-check" style="width: 18px; height: 18px; accent-color: var(--purple);" onchange="checkReady()">
                <span>Quiet environment (I can speak clearly)</span>
            </label>
        </div>
    </div>
    <div style="text-align: center; margin-top: 16px;">
        <div id="adaptiveAuthBar" class="adaptive-auth-bar standard" style="display:none;"></div>
        <div class="modalities-mini" style="justify-content: center; display: none;" id="modalityChips">
            <div class="mod-chip" data-mod="video_liveness"><span class="dot"></span>Face Liveness</div>
            <div class="mod-chip" data-mod="deepfake_detection"><span class="dot"></span>Deepfake Detection</div>
            <div class="mod-chip" data-mod="voice_biometric"><span class="dot"></span>Voiceprint</div>
            <div class="mod-chip" data-mod="lip_sync"><span class="dot"></span>Lip-Sync</div>
            <div class="mod-chip" data-mod="otp_verification"><span class="dot"></span>Challenge Response</div>
            <div class="mod-chip" data-mod="geolocation"><span class="dot"></span>Geolocation</div>
        </div>
    </div>
</div>

<!-- STEP 2: Challenge + Recording -->
<div class="step-section" id="step2">
    <div class="header" style="padding-bottom: 16px;">
        <div class="header-eyebrow">Step 3 of 4</div>
        <div class="header-title">Speak the Challenge</div>
    </div>
    <div class="camera-container recording" id="cameraBoxRec">
        <video id="videoPreviewRec" autoplay playsinline muted></video>
        <div class="camera-overlay">
            <div class="camera-corners"></div>
            <div class="camera-corners-bottom"></div>
            <div class="face-oval">
                <svg viewBox="0 0 180 240" width="180" height="240">
                    <ellipse class="face-oval-ring" cx="90" cy="120" rx="75" ry="105"/>
                </svg>
            </div>
            <div class="rec-indicator" id="recIndicator" style="display:none;">
                <span class="rec-dot"></span>REC
            </div>
            <div class="audio-level" id="audioLevel" style="display:none;">
                <div class="audio-bar" id="ab0" style="height:2px;"></div>
                <div class="audio-bar" id="ab1" style="height:2px;"></div>
                <div class="audio-bar" id="ab2" style="height:2px;"></div>
                <div class="audio-bar" id="ab3" style="height:2px;"></div>
                <div class="audio-bar" id="ab4" style="height:2px;"></div>
            </div>
            </div>
            <div class="camera-challenge">
                <div class="camera-challenge-text" id="challengeText">Loading challenge…</div>
                <div class="camera-challenge-sub">Read this aloud while looking at the camera</div>
            </div>
        </div>
    </div>
    <div class="timer-label" id="timerLabel">Recording in</div>
    <div class="countdown-ring-wrap" id="countdownRingWrap">
        <svg viewBox="0 0 100 100">
            <circle class="ring-bg" cx="50" cy="50" r="39"/>
            <circle class="ring-fill" cx="50" cy="50" r="39" id="countdownRingFill" style="stroke-dasharray: 245; stroke-dashoffset: 0;"/>
        </svg>
        <div class="countdown-number" id="countdownTimer">3</div>
    </div>
</div>

<!-- STEP 3: Processing — REAL verification -->
<div class="step-section" id="step3">
    <div class="header">
        <div class="header-eyebrow">Step 4 of 4</div>
        <div class="header-title">Verifying Identity</div>
        <div class="header-sub" id="verifySubtitle">Sending biometric data to verification engines…</div>
    </div>
    <div class="progress-container">
        <div class="progress-ring">
            <svg viewBox="0 0 80 80">
                <circle class="ring-bg" cx="40" cy="40" r="36"/>
                <circle class="ring-fill" cx="40" cy="40" r="36" id="progressRing"/>
            </svg>
        </div>
        <div class="progress-step" id="progressStep">Uploading recording…</div>
        <div class="progress-detail" id="progressDetail">Video + Audio → Gemini + Deepgram</div>
    </div>
    <div class="modality-results" id="modalityResults">
        <div class="mod-result" id="modFace"><span class="mod-status">⏳</span><span class="mod-name">Face Liveness</span><span class="mod-score pending">—</span></div>
        <div class="mod-result" id="modDeepfake"><span class="mod-status">⏳</span><span class="mod-name">Deepfake Detection</span><span class="mod-score pending">—</span></div>
        <div class="mod-result" id="modVoice"><span class="mod-status">⏳</span><span class="mod-name">Voiceprint</span><span class="mod-score pending">—</span></div>
        <div class="mod-result" id="modLipSync"><span class="mod-status">⏳</span><span class="mod-name">Lip-Sync</span><span class="mod-score pending">—</span></div>
        <div class="mod-result" id="modChallenge"><span class="mod-status">⏳</span><span class="mod-name">Challenge Response</span><span class="mod-score pending">—</span></div>
        <div class="mod-result" id="modGeo"><span class="mod-status">⏳</span><span class="mod-name">Geolocation</span><span class="mod-score pending">—</span></div>
    </div>
    <div id="retrySection" style="display:none; margin-top: 20px;">
        <div id="failReasonCard" style="background: var(--error-bg); border: 1px solid var(--error-border); border-radius: 8px; padding: 14px 16px; margin-bottom: 14px;">
            <div style="font-family: var(--mono); font-size: 11px; font-weight: 600; color: var(--error); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">Why it failed</div>
            <div id="failReasons" style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;"></div>
        </div>
        <div id="retryTips" style="background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; margin-bottom: 14px;">
            <div style="font-family: var(--mono); font-size: 11px; font-weight: 600; color: var(--teal); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">Try this</div>
            <div id="retryTipsList" style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;"></div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-primary" onclick="retryVerification()" style="flex: 1;">Retry Verification</button>
            <button class="btn-secondary" onclick="showSuccess()" id="btnContinueAnyway" style="flex: 0 0 auto; display: none;">Continue Anyway</button>
        </div>
        <div style="font-family: var(--mono); font-size: 11px; color: var(--text-quaternary); text-align: center; margin-top: 8px;" id="retryCount"></div>
    </div>
</div>

<!-- STEP 4: Success -->
<div class="step-section" id="step4">
    <div class="header">
        <div class="header-eyebrow" id="successEyebrow">Verified ✓</div>
        <div class="header-title" id="successTitle">You're Verified</div>
        <div class="header-sub">Your identity is now cryptographically bound. Share your credential or send a verified message.</div>
    </div>

    <!-- Identity card — compact -->
    <div class="chain-result" style="text-align: center;">
        <svg width="40" height="40" viewBox="0 0 100 100" style="margin-bottom: 12px;" id="successIcon">
            <polygon points="50,8 92,30 92,70 50,92 8,70 8,30" fill="none" stroke="#3FB950" stroke-width="4"/>
            <polygon points="50,24 76,38 76,62 50,76 24,62 24,38" fill="#3FB950" fill-opacity="0.1" stroke="#3FB950" stroke-width="2"/>
            <path d="M35 50 L45 60 L65 40" fill="none" stroke="#3FB950" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="successName"></div>
        <div style="font-family: var(--mono); font-size: 12px; color: var(--text-tertiary); margin-top: 4px;" id="successOrg"></div>
        <div style="font-family: var(--mono); font-size: 13px; color: var(--teal); margin-top: 8px;" id="successScore"></div>
        <div class="modalities-mini" style="justify-content: center; margin-top: 14px;" id="successModalities"></div>
    </div>

    <!-- Primary CTA: Share -->
    <div class="share-card">
        <div style="font-family: var(--mono); font-size: 11px; color: var(--text-tertiary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px;">Your Verification Link</div>
        <div class="share-url" id="shareUrl" onclick="copyShareUrl()"></div>
        <div id="copyFeedback" style="font-family: var(--mono); font-size: 11px; color: var(--success); text-align: center; height: 16px;"></div>
        <div style="border-top: 1px solid var(--border); margin-top: 12px; padding-top: 12px;">
            <div style="font-family: var(--mono); font-size: 11px; color: var(--text-tertiary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px;">Email it to someone</div>
            <div class="form-row">
                <input class="form-input" id="recipientName" type="text" placeholder="Their name">
                <input class="form-input" id="recipientEmail" type="email" placeholder="email@example.com">
            </div>
            <button class="btn-primary" style="width: 100%; margin-top: 10px;" id="btnSend" onclick="sendToRecipient()">
                Send Verification
            </button>
            <div id="sendFeedback" class="error-msg" style="display:none;"></div>
        </div>
    </div>

    <!-- Secondary actions -->
    <div style="display: flex; gap: 10px; margin-top: 12px;">
        <button class="btn-secondary" onclick="openMessage()" style="flex: 1;">Send Verified Message</button>
    </div>

    <!-- Collapsible detail sections -->
    <div style="margin-top: 20px;">
        <!-- Transcript -->
        <div class="transcript-card" id="transcriptCard" style="display:none;">
            <div class="transcript-label">What You Said</div>
            <div class="transcript-text" id="transcriptText"></div>
            <div class="transcript-match" id="transcriptMatch"></div>
        </div>

        <!-- Delegation chain (collapsed by default) -->
        <details style="margin-top: 12px;">
            <summary style="font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--text-tertiary); letter-spacing: 1px; text-transform: uppercase; cursor: pointer; padding: 8px 0; list-style: none; display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 10px;">▶</span> Delegation Chain
            </summary>
            <div class="chain-result" id="chainDisplay" style="margin-top: 8px;"></div>
        </details>

        <!-- Patent claims (collapsed by default) -->
        <details style="margin-top: 8px;">
            <summary style="font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--text-tertiary); letter-spacing: 1px; text-transform: uppercase; cursor: pointer; padding: 8px 0; list-style: none; display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 10px;">▶</span> Patent Claims Demonstrated
            </summary>
            <div class="chain-result" style="margin-top: 8px;"><div class="claim-pills" id="claimPills"></div></div>
        </details>
    </div>

    <div class="footer-tagline">Math so neither party has to rely on trust alone.</div>
</div>

</div><!-- .page -->

<div class="scroll-hint" id="scrollHint">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-tertiary);">
        <polyline points="6 9 12 15 18 9"/>
    </svg>
</div>

<script>
const API_BASE = 'https://vac-system-production.up.railway.app';

let currentStep = 0;
let mediaStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let authResult = null;
let challengeData = null;
let retryAttempts = 0;
const MAX_RETRIES = 3;
let audioContext = null;
let audioAnalyser = null;
let audioAnimFrame = null;

function toggleOrgFields() {
    const el = document.getElementById('optionalFields');
    const btn = document.getElementById('toggleOrgBtn');
    const showing = el.style.display === 'none';
    el.style.display = showing ? 'block' : 'none';
    btn.textContent = showing ? '− Hide organisation details' : '+ Add organisation details';
}

// Fail reason descriptions — specific, actionable (Veriff/iProov pattern)
const FAIL_REASONS = {
    face_liveness: {
        reason: 'Face not detected or liveness check failed.',
        tip: 'Make sure your face is clearly visible, well-lit, and centered in the oval. Remove sunglasses or hats.'
    },
    deepfake_detection: {
        reason: 'Deepfake indicators detected in the video.',
        tip: 'Use your device camera directly — screen sharing, virtual cameras, or recorded playback will be rejected.'
    },
    voiceprint: {
        reason: 'Voice not captured clearly enough for analysis.',
        tip: 'Speak the challenge phrase clearly and at normal volume. Reduce background noise if possible.'
    },
    lip_sync: {
        reason: 'Lip movements did not match the spoken audio.',
        tip: 'Look directly at the camera while speaking. Make sure your mouth is visible and well-lit.'
    },
    challenge_response: {
        reason: 'Spoken words did not match the challenge phrase.',
        tip: 'Read the challenge phrase exactly as shown — include the greeting and all digits.'
    },
    geolocation: {
        reason: 'Location could not be determined.',
        tip: 'Allow location access when prompted by your browser.'
    },
};

// User data helper
const userData = () => ({
    name: document.getElementById('inputName').value.trim(),
    email: document.getElementById('inputEmail').value.trim(),
    org: document.getElementById('inputOrg').value.trim(),
    role: document.getElementById('inputRole').value.trim(),
});

// Step navigation
function goToStep(n) {
    document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${n}`).classList.add('active');
    for (let i = 0; i <= 3; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (!dot) continue;
        dot.classList.remove('active', 'done');
        if (i < n) dot.classList.add('done');
        if (i === n) dot.classList.add('active');
    }
    for (let i = 0; i <= 2; i++) {
        const line = document.getElementById(`line${i}`);
        if (line) line.classList.toggle('done', i < n);
    }
    currentStep = n;
}

// STEP 0 → 1: Identity → Camera
function goToCamera() {
    const d = userData();
    const errEl = document.getElementById('identityError');
    if (!d.name || !d.email) {
        errEl.textContent = 'Name and email are required.';
        errEl.style.display = 'block';
        return;
    }
    errEl.style.display = 'none';
    goToStep(1);
}

// STEP 1: Request camera + fetch challenge from backend
async function requestCamera() {
    const btn = document.getElementById('btnCamera');
    const err = document.getElementById('cameraError');
    err.style.display = 'none';
    btn.disabled = true;
    btn.textContent = 'Requesting access…';

    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 960 } },
            audio: true,
        });
        const vid = document.getElementById('videoPreview');
        vid.srcObject = mediaStream;
        vid.muted = true;
        vid.setAttribute('playsinline', '');
        await vid.play().catch(() => {});
        document.getElementById('cameraLabel').textContent = 'CAMERA ACTIVE';

        // Fetch challenge from backend
        btn.textContent = 'Loading challenge…';
        const d = userData();
        const resp = await fetch(`${API_BASE}/v1/vat/auth/challenge`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: d.name, risk_level: 'medium' }),
        });
        challengeData = await resp.json();

        btn.textContent = 'Proceed to Challenge';
        btn.disabled = true;
        btn.onclick = goToChallenge;
        // Show pre-recording checklist
        document.getElementById('preRecordChecklist').style.display = 'block';
        checkReady();
        // Fetch adaptive modality requirements
        fetchModalityRequirements();
    } catch (e) {
        err.textContent = e.message || 'Camera access denied. Please allow camera and microphone.';
        err.style.display = 'block';
        btn.textContent = 'Retry Camera Access';
        btn.disabled = false;
    }
}

// Pre-recording readiness check
function checkReady() {
    const checks = document.querySelectorAll('.pre-check');
    const allChecked = Array.from(checks).every(c => c.checked);
    const btn = document.getElementById('btnCamera');
    if (btn.textContent === 'Proceed to Challenge' || btn.textContent.includes('Ready')) {
        btn.disabled = !allChecked;
        btn.textContent = allChecked ? 'Ready — Proceed to Challenge' : 'Proceed to Challenge';
    }
}

// STEP 1 → 2: Challenge
function goToChallenge() {
    const phrase = challengeData?.phrase || `I am ${userData().name}, authorising VAC Protocol`;
    document.getElementById('challengeText').textContent = `"${phrase}"`;
    const recVid = document.getElementById('videoPreviewRec');
    recVid.srcObject = mediaStream;
    recVid.muted = true;
    recVid.setAttribute('playsinline', '');
    recVid.play().catch(() => {});
    goToStep(2);
    startCountdown();
}

// STEP 2: Countdown then record
function startCountdown() {
    const timerEl = document.getElementById('countdownTimer');
    const ringFill = document.getElementById('countdownRingFill');
    const circumference = 2 * Math.PI * 39;
    let count = 3;
    timerEl.textContent = count;
    ringFill.style.strokeDashoffset = 0;

    const interval = setInterval(() => {
        count--;
        if (count > 0) {
            timerEl.textContent = count;
            ringFill.style.strokeDashoffset = circumference * ((3 - count) / 3);
        } else {
            clearInterval(interval);
            timerEl.textContent = '●';
            ringFill.classList.add('recording');
            ringFill.style.strokeDashoffset = 0;
            beginRecording();
        }
    }, 1000);
}

function beginRecording() {
    document.getElementById('recIndicator').style.display = 'flex';
    document.getElementById('audioLevel').style.display = 'flex';
    document.getElementById('cameraBoxRec').classList.add('recording');
    document.getElementById('timerLabel').textContent = 'Recording';

    // Start audio level monitoring
    startAudioMonitor();

    recordedChunks = [];

    // MediaRecorder mimeType fallback chain (Chrome → Safari → default)
    const mimeTypes = [
        'video/webm;codecs=vp9,opus',
        'video/webm;codecs=vp8,opus',
        'video/webm',
        'video/mp4',
    ];
    let selectedMime = '';
    for (const mime of mimeTypes) {
        if (MediaRecorder.isTypeSupported(mime)) {
            selectedMime = mime;
            break;
        }
    }

    const options = selectedMime ? { mimeType: selectedMime } : {};
    mediaRecorder = new MediaRecorder(mediaStream, options);
    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => { onRecordingComplete(); };
    mediaRecorder.start();

    // Record for 5 seconds
    let remaining = 5;
    const timerEl = document.getElementById('countdownTimer');
    const ringFill = document.getElementById('countdownRingFill');
    const circumference = 2 * Math.PI * 39;
    timerEl.textContent = remaining;
    ringFill.classList.add('recording');
    ringFill.style.strokeDashoffset = 0;

    const recInterval = setInterval(() => {
        remaining--;
        timerEl.textContent = remaining;
        ringFill.style.strokeDashoffset = circumference * ((5 - remaining) / 5);
        if (remaining <= 0) {
            clearInterval(recInterval);
            mediaRecorder.stop();
        }
    }, 1000);
}

// Recording complete → upload to backend for real verification
async function onRecordingComplete() {
    document.getElementById('recIndicator').style.display = 'none';
    document.getElementById('cameraBoxRec').classList.remove('recording');
    stopAudioMonitor();

    // Stop camera
    if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
    }

    goToStep(3);

    // Build the blob
    const videoBlob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || 'video/webm' });
    
    await runRealVerification(videoBlob);
}

// STEP 3: Upload to backend, show real results
async function runRealVerification(videoBlob) {
    const ring = document.getElementById('progressRing');
    const stepEl = document.getElementById('progressStep');
    const detailEl = document.getElementById('progressDetail');
    const circumference = 2 * Math.PI * 36;

    // Progress animation while we wait for backend
    stepEl.textContent = 'Uploading recording…';
    detailEl.textContent = `${(videoBlob.size / 1024).toFixed(0)} KB → verification engines`;
    ring.style.strokeDashoffset = circumference * 0.85;

    // Set geolocation as verified immediately (it's browser-side)
    updateModality('modGeo', 'verified', 1.0);

    try {
        // Build multipart form data
        const formData = new FormData();
        formData.append('video', videoBlob, 'capture.webm');
        formData.append('challenge_id', challengeData?.challenge_id || 'none');
        formData.append('name', userData().name);
        formData.append('email', userData().email);
        formData.append('org_name', userData().org);
        formData.append('org_role', userData().role);

        stepEl.textContent = 'Analysing biometrics…';
        detailEl.textContent = 'Gemini (face) + Deepgram (voice)';
        ring.style.strokeDashoffset = circumference * 0.6;

        // Send to backend
        const resp = await fetch(`${API_BASE}/v1/vat/auth/verify`, {
            method: 'POST',
            body: formData,
        });

        if (!resp.ok) {
            const errText = await resp.text();
            throw new Error(`Server error ${resp.status}: ${errText.substring(0, 200)}`);
        }

        authResult = await resp.json();

        // Update modality displays with real results
        ring.style.strokeDashoffset = circumference * 0.2;
        stepEl.textContent = 'Processing results…';

        const mods = authResult.biometric_verification?.modalities || [];
        for (const mod of mods) {
            const elId = {
                'face_liveness': 'modFace',
                'deepfake_detection': 'modDeepfake',
                'voiceprint': 'modVoice',
                'lip_sync': 'modLipSync',
                'challenge_response': 'modChallenge',
                'geolocation': 'modGeo',
            }[mod.name];
            if (elId) {
                updateModality(elId, mod.status, mod.score);
                await sleep(300); // Stagger for visual effect
            }
        }

        // Final state
        ring.style.strokeDashoffset = 0;
        const passed = authResult.authenticated;
        if (passed) {
            stepEl.textContent = 'Identity verified ✓';
            ring.style.stroke = 'var(--success)';
            detailEl.textContent = `Trust score: ${authResult.biometric_verification.overall_score}`;
            await sleep(800);
            showSuccess();
        } else {
            stepEl.textContent = 'Verification incomplete';
            ring.style.stroke = 'var(--warning)';
            detailEl.textContent = `Trust score: ${authResult.biometric_verification.overall_score}`;
            showRetry(authResult);
        }

    } catch (e) {
        stepEl.textContent = 'Verification error';
        detailEl.textContent = e.message || 'Network error — check connection';
        ring.style.stroke = 'var(--error)';
        console.error('Verification failed:', e);
        // Show retry for network errors too
        const retryEl = document.getElementById('retrySection');
        retryEl.style.display = 'block';
        document.getElementById('failReasons').textContent = e.message || 'Network error during verification.';
        document.getElementById('retryTipsList').textContent = 'Check your internet connection and try again. If the problem persists, try a different browser.';
        retryAttempts++;
        document.getElementById('retryCount').textContent = `Attempt ${retryAttempts} of ${MAX_RETRIES}`;
        if (retryAttempts >= MAX_RETRIES) {
            document.getElementById('btnContinueAnyway').style.display = 'inline-flex';
        }
    }
}

function updateModality(elId, status, score) {
    const el = document.getElementById(elId);
    if (!el) return;
    const statusEl = el.querySelector('.mod-status');
    const scoreEl = el.querySelector('.mod-score');

    if (status === 'verified') {
        statusEl.textContent = '✓';
        statusEl.style.color = 'var(--success)';
        scoreEl.textContent = typeof score === 'number' ? score.toFixed(2) : '—';
        scoreEl.className = 'mod-score pass';
    } else if (status === 'failed') {
        statusEl.textContent = '✗';
        statusEl.style.color = 'var(--error)';
        scoreEl.textContent = typeof score === 'number' ? score.toFixed(2) : '—';
        scoreEl.className = 'mod-score fail';
    } else if (status === 'error') {
        statusEl.textContent = '⚠';
        statusEl.style.color = 'var(--warning)';
        scoreEl.textContent = 'err';
        scoreEl.className = 'mod-score fail';
    } else {
        statusEl.textContent = '~';
        scoreEl.textContent = typeof score === 'number' ? score.toFixed(2) : '—';
        scoreEl.className = 'mod-score pending';
    }
}

// Show retry with specific fail reasons
function showRetry(result) {
    retryAttempts++;
    const retryEl = document.getElementById('retrySection');
    retryEl.style.display = 'block';

    // Collect failed modalities
    const mods = result.biometric_verification?.modalities || [];
    const failed = mods.filter(m => m.status === 'failed' || m.status === 'error');

    if (failed.length > 0) {
        const reasons = failed.map(m => {
            const info = FAIL_REASONS[m.name] || { reason: `${m.name} check failed.`, tip: '' };
            return info.reason;
        });
        const tips = failed.map(m => {
            const info = FAIL_REASONS[m.name] || { reason: '', tip: 'Try again with better conditions.' };
            return info.tip;
        }).filter(Boolean);

        document.getElementById('failReasons').innerHTML = reasons.map(r =>
            `<div style="margin-bottom: 4px;">${r}</div>`
        ).join('');
        document.getElementById('retryTipsList').innerHTML = [...new Set(tips)].map(t =>
            `<div style="margin-bottom: 4px;">${t}</div>`
        ).join('');
    } else {
        document.getElementById('failReasons').textContent = 'Verification did not reach the required trust threshold.';
        document.getElementById('retryTipsList').textContent = 'Ensure good lighting, speak clearly, and look directly at the camera.';
    }

    document.getElementById('retryCount').textContent = `Attempt ${retryAttempts} of ${MAX_RETRIES}`;

    // After max retries, offer "continue anyway" (mints partial chain)
    if (retryAttempts >= MAX_RETRIES) {
        document.getElementById('btnContinueAnyway').style.display = 'inline-flex';
    }
}

// Retry: go back to camera step with fresh challenge
async function retryVerification() {
    if (retryAttempts >= MAX_RETRIES) return;

    // Reset modality displays
    ['modFace', 'modDeepfake', 'modVoice', 'modLipSync', 'modChallenge', 'modGeo'].forEach(id => {
        updateModality(id, 'pending', null);
    });

    // Hide retry section
    document.getElementById('retrySection').style.display = 'none';

    // Re-request camera
    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 960 } },
            audio: true,
        });
    } catch (e) {
        // Camera may still be available from before
    }

    // Fetch fresh challenge
    const d = userData();
    try {
        const resp = await fetch(`${API_BASE}/v1/vat/auth/challenge`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: d.name, risk_level: 'medium' }),
        });
        challengeData = await resp.json();
    } catch (e) {
        console.error('Failed to fetch new challenge:', e);
    }

    // Set up recording preview
    const phrase = challengeData?.phrase || `I am ${d.name}, authorising VAC Protocol`;
    document.getElementById('challengeText').textContent = `"${phrase}"`;
    const recVid = document.getElementById('videoPreviewRec');
    recVid.srcObject = mediaStream;
    recVid.muted = true;
    recVid.setAttribute('playsinline', '');
    recVid.play().catch(() => {});

    // Reset countdown ring
    const ringFill = document.getElementById('countdownRingFill');
    ringFill.classList.remove('recording');
    ringFill.style.strokeDashoffset = 0;

    // Go to recording step
    goToStep(2);
    startCountdown();
}

// STEP 4: Success
function showSuccess() {
    const d = userData();
    const r = authResult;
    const bio = r.biometric_verification;

    document.getElementById('successName').textContent = d.name;
    document.getElementById('successOrg').textContent = [d.role, d.org].filter(Boolean).join(' · ') || 'Verified Human';
    document.getElementById('successScore').textContent = `Trust Score: ${bio.overall_score} · ${bio.trust_level}`;

    // Update header based on pass/fail
    if (!r.authenticated) {
        document.getElementById('successEyebrow').textContent = 'Partial Verification';
        document.getElementById('successEyebrow').style.color = 'var(--warning)';
        document.getElementById('successTitle').textContent = 'Authority Chain Minted (Partial)';
    }

    // Verification method badge
    const method = r.verification_method === 'real_biometric' ? 'Real Biometric' : 'Simulated';

    // Modalities with real status
    const modEl = document.getElementById('successModalities');
    const mods = bio.modalities || [];
    modEl.innerHTML = mods.map(m => {
        const cls = m.status === 'verified' ? '' : 'failed';
        return `<div class="mod-chip ${cls}"><span class="dot"></span>${m.name.replace(/_/g, ' ')} ${m.score ? '(' + m.score.toFixed(2) + ')' : ''}</div>`;
    }).join('');

    // Transcript display
    if (r.challenge?.transcript) {
        document.getElementById('transcriptCard').style.display = 'block';
        document.getElementById('transcriptText').textContent = `"${r.challenge.transcript}"`;
        const matchEl = document.getElementById('transcriptMatch');
        const expected = r.challenge.phrase;
        const heard = r.challenge.transcript;
        if (expected && heard) {
            const matchColor = r.authenticated ? 'var(--success)' : 'var(--warning)';
            matchEl.innerHTML = `<span style="color:${matchColor}">Expected:</span> "${expected}"`;
        }
    }

    // Chain display
    const chainEl = document.getElementById('chainDisplay');
    const nodes = (r.chain || []).map((c, i) => ({
        icon: i === 0 ? '👤' : '🤖',
        cls: i === 0 ? 'human' : 'agent',
        name: c.agent,
        scope: i === 0 ? 'Root authority · 5 resources · 5 actions' : i === 1 ? '2 resources · read, summarise' : '1 resource · read only',
        trust: c.trust,
    }));
    chainEl.innerHTML = nodes.map((n, i) => {
        const arrow = i < nodes.length - 1 ? '<div class="chain-arrow">↓ delegates (scope narrows)</div>' : '';
        const trustCls = n.trust >= 0.9 ? 'high' : 'mid';
        return `
            <div class="chain-node-result">
                <div class="chain-icon ${n.cls}">${n.icon}</div>
                <div class="chain-info">
                    <div class="chain-agent-name">${n.name}</div>
                    <div class="chain-scope">${n.scope}</div>
                </div>
                <div class="chain-trust ${trustCls}">${n.trust.toFixed(2)}</div>
            </div>
            ${arrow}`;
    }).join('');

    // Share URL
    document.getElementById('shareUrl').textContent = r.share_url;

    // Claim pills
    const claims = [
        { range: '1–15', label: 'Biometric binding', active: true },
        { range: '16–38', label: 'Trust scoring', active: true },
        { range: '39–55', label: 'Scope constraints', active: true },
        { range: '56–112', label: 'Chain verification', active: true },
        { range: '113–134', label: 'Multi-agent coord', active: true },
        { range: '135–167', label: 'Cross-org federation', active: false },
        { range: '168–241', label: 'Collective governance', active: false },
        { range: '242–271', label: 'Spend controls', active: false },
        { range: '272–285', label: 'Trust graph', active: true },
    ];
    document.getElementById('claimPills').innerHTML = claims.map(c =>
        `<span class="claim-pill ${c.active ? 'active' : ''}">${c.range}: ${c.label}</span>`
    ).join('');

    goToStep(4);
}

// Share actions
function copyShareUrl() {
    const url = authResult?.share_url;
    if (!url) return;
    navigator.clipboard.writeText(url).then(() => {
        const fb = document.getElementById('copyFeedback');
        fb.textContent = 'Copied to clipboard ✓';
        setTimeout(() => fb.textContent = '', 2000);
    });
}

async function sendToRecipient() {
    const name = document.getElementById('recipientName').value.trim();
    const email = document.getElementById('recipientEmail').value.trim();
    const btn = document.getElementById('btnSend');
    const fb = document.getElementById('sendFeedback');

    if (!email) { fb.textContent = 'Email required'; fb.style.display = 'block'; fb.style.color = 'var(--error)'; return; }

    btn.disabled = true;
    btn.textContent = 'Sending…';
    fb.style.display = 'none';

    try {
        const d = userData();
        const resp = await fetch(`${API_BASE}/v1/vat/auth/capture`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: d.name,
                email: d.email,
                org_name: d.org,
                org_role: d.role,
                recipient_name: name,
                recipient_email: email,
            }),
        });
        const data = await resp.json();
        if (data.recipient_notified) {
            fb.textContent = `Sent to ${email} ✓`;
            fb.style.color = 'var(--success)';
            fb.style.display = 'block';
            document.getElementById('shareUrl').textContent = data.share_url;
        } else {
            fb.textContent = data.recipient_error || 'Failed to send — try again';
            fb.style.color = 'var(--error)';
            fb.style.display = 'block';
        }
    } catch (e) {
        fb.textContent = 'Network error';
        fb.style.color = 'var(--error)';
        fb.style.display = 'block';
    }
    btn.disabled = false;
    btn.textContent = 'Send Verification Link';
}

// Fetch adaptive modality requirements based on trust relationship
async function fetchModalityRequirements() {
    const email = userData().email;
    if (!email) return;
    try {
        const resp = await fetch(`${API_BASE}/v1/modality-requirements/${encodeURIComponent(email)}`);
        if (!resp.ok) return;
        const data = await resp.json();
        const policy = data.modality_policy;
        if (!policy) return;

        // Show adaptive bar
        const bar = document.getElementById('adaptiveAuthBar');
        const lvl = policy.label.toLowerCase();
        bar.className = `adaptive-auth-bar ${lvl}`;
        bar.textContent = `${policy.label}: ${policy.total_required} of ${policy.total_available} modalities required`;
        bar.style.display = 'block';

        // Update chips: dim optional/can-skip
        const chips = document.querySelectorAll('#modalityChips .mod-chip');
        chips.forEach(chip => {
            const mod = chip.dataset.mod;
            chip.classList.remove('optional', 'recommended');
            if (policy.can_skip && policy.can_skip.includes(mod)) {
                chip.classList.add('optional');
            } else if (policy.optional && policy.optional.includes(mod)) {
                chip.classList.add('optional');
            } else if (policy.recommended && policy.recommended.includes(mod)) {
                chip.classList.add('recommended');
            }
        });
    } catch (e) {
        // Silently fail — default to showing all modalities as required
        console.warn('Could not fetch modality requirements:', e);
    }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// Audio level monitoring
function startAudioMonitor() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(mediaStream);
        audioAnalyser = audioContext.createAnalyser();
        audioAnalyser.fftSize = 256;
        source.connect(audioAnalyser);

        const dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
        const bars = [0,1,2,3,4].map(i => document.getElementById(`ab${i}`));

        function updateLevels() {
            audioAnalyser.getByteFrequencyData(dataArray);
            // RMS-based level with noise gate (FolioAI learning: raw FFT triggers on ambient)
            let rms = 0;
            for (let i = 0; i < dataArray.length; i++) rms += dataArray[i] * dataArray[i];
            rms = Math.sqrt(rms / dataArray.length) / 255;
            const gated = rms > 0.05 ? rms : 0; // Noise gate: ignore below 5% RMS

            const step = Math.floor(dataArray.length / 5);
            for (let i = 0; i < 5; i++) {
                const bandVal = dataArray[i * step] / 255;
                const val = gated > 0 ? bandVal : 0;
                const h = Math.max(2, val * 20);
                if (bars[i]) bars[i].style.height = h + 'px';
            }
            audioAnimFrame = requestAnimationFrame(updateLevels);
        }
        updateLevels();
    } catch (e) {
        console.warn('Audio monitor unavailable:', e);
    }
}

function stopAudioMonitor() {
    if (audioAnimFrame) cancelAnimationFrame(audioAnimFrame);
    if (audioContext) audioContext.close().catch(() => {});
    audioContext = null;
    audioAnalyser = null;
    document.getElementById('audioLevel').style.display = 'none';
}

function openMessage() {
    const email = userData().email;
    const name = userData().name;
    const url = `/msg?compose=1&from=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}`;
    window.open(url, '_blank');
}
</script>
<script src="vac-themes.js"></script>
<script>
// Apply theme from URL param or auto-detect from email
if (typeof VACTheme !== 'undefined') {
    const params = new URLSearchParams(window.location.search);
    const urlTheme = params.get('theme');
    if (urlTheme) {
        VACTheme.apply(urlTheme);
    }
    // Also auto-detect when email is entered
    const emailInput = document.getElementById('inputEmail');
    if (emailInput) {
        emailInput.addEventListener('blur', () => {
            const theme = VACTheme.detectFromEmail(emailInput.value);
            if (theme !== 'default') VACTheme.apply(theme);
        });
    }
}
</script>
<script>
// Scroll indicator — hide when near bottom or not scrollable
function checkScroll() {
    const hint = document.getElementById('scrollHint');
    if (!hint) return;
    const scrollable = document.documentElement.scrollHeight > window.innerHeight + 50;
    const nearBottom = (window.innerHeight + window.scrollY) >= document.documentElement.scrollHeight - 60;
    hint.classList.toggle('hidden', !scrollable || nearBottom);
}
window.addEventListener('scroll', checkScroll, { passive: true });
window.addEventListener('resize', checkScroll);
setTimeout(checkScroll, 200);
// Re-check after step transitions
const _origGoToStep = goToStep;
goToStep = function(n) { _origGoToStep(n); setTimeout(checkScroll, 150); };
</script>

</body>
</html>
